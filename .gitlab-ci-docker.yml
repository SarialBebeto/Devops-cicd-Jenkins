stages:
  - update
  - build
  - test
  - deploy_dev
  - deploy_prod

variables:
  IMAGE_TAG: latest
  DOCKER_DRIVER: overlay2

update:
  stage: update
  image: python:3.11
  script:
    - python -m venv .venv
    - pip install --upgrade pip
    - pip install -r requirements.txt
  artifacts:
    paths:
      - .venv/
    expire_in: 1 hour

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "$DOCKER_REGISTRY_PASSWORD" | docker login -u "$DOCKER_REGISTRY_USER" --password-stdin 
    - docker build -t "$DOCKER_REGISTRY_USER/fastapi-dev:$IMAGE_TAG" -f Dockerfile .
    - docker push "$DOCKER_REGISTRY_USER/fastapi-dev:$IMAGE_TAG"
    - docker build -t "$DOCKER_REGISTRY_USER/fastapi-prod:$IMAGE_TAG" -f Dockerfile.prod .
    - docker push "$DOCKER_REGISTRY_USER/fastapi-prod:$IMAGE_TAG"
    - docker build -t "$DOCKER_REGISTRY_USER/fastapi-traefik:$IMAGE_TAG" -f Dockerfile.traefik .
    - docker push "$DOCKER_REGISTRY_USER/fastapi-traefik:$IMAGE_TAG"
  only:
    - main

unit-test:
  stage: test
  image: python:3.12-slim
  script:
    # --- Unit tests ---
    - rm -rf .venv
    - apt-get update && apt-get install -y --no-install-recommends \
        gcc \
        build-essential \
        libpq-dev \
        python3-dev \
        curl \
        && rm -rf /var/lib/apt/lists/*
    - which gcc
    - which python3
    - gcc --version
    - python3 --version
    - python3 -m venv .venv
    - . .venv/bin/activate
    - pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt pytest
    - pytest -v --maxfail=1 --disable-warnings --junitxml=report.xml # the test is run at this stage
  artifacts:
    when: always
    reports:
      junit: report.xml
  only:
    - main  

smoke-tests:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    # --- Smoke test with container ---
    - echo "Building and running Docker container for smoke tests"
    - docker build -t test-app:$CI_COMMIT_SHORT_SHA  .
    - docker run -d -p 8000:8000 --name test-app test-app:$CI_COMMIT_SHORT_SHA 
    - sleep 10  # Wait for the app to start
    - curl -f http://localhost:8000/ || (echo "Health check failed!" && exit 1)
    - curl -f http://localhost:8000/docs 
  only:
    - main

deploy_dev:
  stage: deploy_dev
  image: docker:24
  services:
    - docker:24-dind
  script:
   - echo "Deploying to Dev..."
   - docker-compose -f docker-compose.yml up -d --build
  environment:
    name: dev
    url: http://dev.example.com
  only:
    - main
    - develop

deploy_prod:
  stage: deploy_prod
  image: docker:24
  services:
    - docker:24-dind
  script:
   - echo "Deploying to Production..."
   - docker-compose -f docker-compose.prod.yml up -d --build
  environment:
    name: Production
    url: http://prod.example.com
  only:
    - main
  when: manual

